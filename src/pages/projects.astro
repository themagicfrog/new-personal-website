---
import PageLayout from '../layouts/PageLayout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import CloudBanner from '../components/CloudBanner.astro';
import { supabase, type Project } from '../lib/supabase';

let projects: Project[] = [];

try {
	const { data, error } = await supabase
		.from('projects')
		.select('*')
		.order('date', { ascending: false });

	if (error) {
		console.error('Error fetching projects:', error);
	} else {
		projects = (data || []).map((project: any) => ({
			...project,
			images: Array.isArray(project.images) ? project.images : []
		}));
	}
} catch (err) {
	console.error('Failed to fetch projects:', err);
}
---

<PageLayout title="Projects - Estella Gu">
	<Breadcrumb items={[
		{ text: 'home', href: '/' },
		{ text: 'projects' }
	]} />
	<CloudBanner />
	<div class="box-content">
		<div class="left-column">
			<h1>projects</h1>
			{projects.length === 0 ? (
				<p>no projects</p>
			) : (
				<div class="projects-list">
					{projects.map((project) => (
						<article class="project-card">
							<div class="project-header">
								<h2>{project.title}</h2>
								{project.date && (
									<time class="project-date">{new Date(project.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
								)}
							</div>
							<p class="project-one-liner">{project.one_liner}</p>
							{project.images && project.images.length > 0 && (
								<div class="project-images-carousel" data-image-count={project.images.length}>
									{project.images.map((image: string, index: number) => (
										<img 
											src={image} 
											alt={`${project.title} - Image ${index + 1}`} 
											loading="lazy"
											class={index === 0 ? 'active' : ''}
											data-index={index}
										/>
									))}
									{project.images.length > 1 && (
										<div class="carousel-indicators">
											{project.images.map((_, index: number) => (
												<span class={`indicator ${index === 0 ? 'active' : ''}`} data-index={index}></span>
											))}
										</div>
									)}
								</div>
							)}
							<p class="project-description">{project.description}</p>
							{project.link && (
								<a href={project.link} target="_blank" rel="noopener noreferrer" class="project-link">
									view more â†’
								</a>
							)}
						</article>
					))}
				</div>
			)}
		</div>
		<div class="right-column"></div>
	</div>
</PageLayout>

<style>
	.projects-list {
		display: flex;
		flex-direction: column;
		gap: 3rem;
		margin-top: 2rem;
	}

	.project-card {
		border: 2px solid var(--text-color);
		border-radius: 10px;
		padding: 2rem;
		background-color: #fafafa;
	}

	.project-header {
		display: flex;
		justify-content: space-between;
		align-items: baseline;
		margin-bottom: 1rem;
		flex-wrap: wrap;
		gap: 1rem;
	}

	.project-card h2 {
		font-family: 'DynaPuff', sans-serif;
		font-size: 2rem;
		margin: 0;
		color: var(--text-color);
	}

	.project-date {
		font-family: 'Dekko', sans-serif;
		font-size: 1rem;
		color: var(--text-color);
		opacity: 0.7;
	}

	.project-one-liner {
		font-family: 'Dekko', sans-serif;
		font-size: 1.3rem;
		font-weight: 600;
		margin: 0.5rem 0 1rem 0;
		color: var(--text-color);
	}

	.project-images-carousel {
		position: relative;
		width: 100%;
		aspect-ratio: 16 / 9;
		margin: 1.5rem 0;
		border-radius: 8px;
		border: 1px solid var(--text-color);
		overflow: hidden;
		cursor: pointer;
	}

	.project-images-carousel img {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		object-fit: cover;
		opacity: 0;
		transition: opacity 0.5s ease-in-out;
		pointer-events: none;
	}

	.project-images-carousel img.active {
		opacity: 1;
		z-index: 1;
	}

	.carousel-indicators {
		position: absolute;
		bottom: 1rem;
		left: 50%;
		transform: translateX(-50%);
		display: flex;
		gap: 0.5rem;
		z-index: 2;
	}

	.carousel-indicators .indicator {
		width: 8px;
		height: 8px;
		border-radius: 50%;
		background-color: rgba(255, 255, 255, 0.5);
		border: 1px solid var(--text-color);
		cursor: pointer;
		transition: background-color 0.3s;
	}

	.carousel-indicators .indicator.active {
		background-color: var(--text-color);
	}

	.project-description {
		font-family: 'Dekko', sans-serif;
		font-size: var(--p-size);
		line-height: 1.6;
		margin: 1rem 0;
		color: var(--text-color);
	}

	.project-link {
		display: inline-block;
		font-family: 'Dekko', sans-serif;
		font-size: 1.2rem;
		color: var(--text-color);
		text-decoration: none;
		margin-top: 1rem;
		transition: opacity 0.2s;
	}

	.project-link:hover {
		opacity: 0.7;
	}

	@media (max-width: 768px) {
		.project-card {
			padding: 1.5rem;
		}

		.project-card h2 {
			font-size: 1.5rem;
		}

		.project-one-liner {
			font-size: 1.1rem;
		}

		.project-images-carousel {
			aspect-ratio: 4 / 3;
		}
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const carousels = document.querySelectorAll('.project-images-carousel');
		
		carousels.forEach((carousel) => {
			const images = carousel.querySelectorAll('img');
			const indicators = carousel.querySelectorAll('.indicator');
			let currentIndex = 0;
			let hoverInterval: number | null = null;
			const imageCount = images.length;

			if (imageCount <= 1) return;

			const showImage = (index: number) => {
				images.forEach((img, i) => {
					img.classList.toggle('active', i === index);
				});
				indicators.forEach((indicator, i) => {
					indicator.classList.toggle('active', i === index);
				});
			};

			const nextImage = () => {
				currentIndex = (currentIndex + 1) % imageCount;
				showImage(currentIndex);
			};

			carousel.addEventListener('mouseenter', () => {
				hoverInterval = window.setInterval(nextImage, 2000);
			});

			carousel.addEventListener('mouseleave', () => {
				if (hoverInterval) {
					clearInterval(hoverInterval);
					hoverInterval = null;
				}
			});

			indicators.forEach((indicator, index) => {
				indicator.addEventListener('click', (e) => {
					e.stopPropagation();
					currentIndex = index;
					showImage(currentIndex);
				});
			});
		});
	});
</script>

