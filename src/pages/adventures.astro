---
import PageLayout from '../layouts/PageLayout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import CloudBanner from '../components/CloudBanner.astro';
import { supabase, type Adventure } from '../lib/supabase';

let adventures: Adventure[] = [];

try {
	const { data, error } = await supabase
		.from('adventures')
		.select('*')
		.order('date', { ascending: false });

	if (error) {
		console.error('Error fetching adventures:', error);
	} else {
		adventures = (data || []).map((adventure: any) => ({
			...adventure,
			one_liner: adventure['one-liner'] || adventure.one_liner || '',
			images: Array.isArray(adventure.images) ? adventure.images : []
		}));
	}
} catch (err) {
	console.error('Failed to fetch adventures:', err);
}
---

<PageLayout title="Adventures - Estella Gu">
	<Breadcrumb items={[
		{ text: 'home', href: '/' },
		{ text: 'adventures' }
	]} />
	<CloudBanner />
	<div class="box-content adventures-page">
		<h1>adventures</h1>
		{adventures.length === 0 ? (
			<p>no adventures</p>
		) : (
			<div class="adventures-list">
				{adventures.map((adventure) => (
					<article class="adventure-card">
						<div class="adventure-header">
							<h2>{adventure.title}</h2>
							{adventure.date && (
								<time class="adventure-date">{new Date(adventure.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
							)}
						</div>
						<p class="adventure-one-liner">{adventure.one_liner}</p>
						{adventure.images && adventure.images.length > 0 && (
							<div class="adventure-images-carousel">
								{adventure.images.map((image: string, index: number) => (
									<img 
										src={image} 
										alt={`${adventure.title} - Image ${index + 1}`} 
										loading="lazy"
										class={index === 0 ? 'active' : ''}
									/>
								))}
								{adventure.images.length > 1 && (
									<div class="carousel-indicators">
										{adventure.images.map((_, index: number) => (
											<span class={`indicator ${index === 0 ? 'active' : ''}`}></span>
										))}
									</div>
								)}
							</div>
						)}
						<p class="adventure-description">{adventure.description}</p>
					</article>
				))}
			</div>
		)}
	</div>
</PageLayout>

<style>
	.adventures-page {
		flex-direction: column;
	}

	.adventures-page h1 {
		margin-bottom: 1rem;
	}

	.adventures-list {
		display: grid;
		grid-template-columns: repeat(2, 1fr);
		gap: 2rem;
		margin-top: 0.2rem;
	}

	.adventure-card {
		border: 2px solid var(--text-color);
		border-radius: 10px;
		padding: 2.5rem;
		background-color: #fafafa;
	}

	.adventure-header {
		display: flex;
		justify-content: space-between;
		align-items: baseline;
		margin-bottom: 1rem;
		flex-wrap: wrap;
		gap: 1rem;
	}

	.adventure-card h2 {
		font-family: 'DynaPuff', sans-serif;
		font-size: 2rem;
		margin: 0;
		color: var(--text-color);
	}

	.adventure-date {
		font-family: 'Dekko', sans-serif;
		font-size: 1rem;
		color: var(--text-color);
		opacity: 0.7;
	}

	.adventure-one-liner {
		font-family: 'Dekko', sans-serif;
		font-size: 1.3rem;
		font-weight: 600;
		margin: 0.5rem 0 1rem 0;
		color: var(--text-color);
	}

	.adventure-images-carousel {
		position: relative;
		width: 100%;
		aspect-ratio: 16 / 9;
		margin: 1.5rem 0;
		border-radius: 8px;
		border: 1px solid var(--text-color);
		overflow: hidden;
		cursor: pointer;
	}

	.adventure-images-carousel img {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		object-fit: cover;
		opacity: 0;
		transition: opacity 0.5s ease-in-out;
		pointer-events: none;
	}

	.adventure-images-carousel img.active {
		opacity: 1;
		z-index: 1;
	}

	.carousel-indicators {
		position: absolute;
		bottom: 1rem;
		left: 50%;
		transform: translateX(-50%);
		display: flex;
		gap: 0.5rem;
		z-index: 2;
	}

	.carousel-indicators .indicator {
		width: 8px;
		height: 8px;
		border-radius: 50%;
		background-color: rgba(255, 255, 255, 0.5);
		border: 1px solid var(--text-color);
		cursor: pointer;
		transition: background-color 0.3s;
	}

	.carousel-indicators .indicator.active {
		background-color: var(--text-color);
	}

	.adventure-description {
		font-family: 'Dekko', sans-serif;
		font-size: 1.1rem;
		line-height: 1.6;
		margin: 1rem 0;
		color: var(--text-color);
	}

	@media (max-width: 768px) {
		.adventures-list {
			grid-template-columns: 1fr;
		}

		.adventure-card {
			padding: 1.5rem;
		}

		.adventure-card h2 {
			font-size: 1.4rem;
		}

		.adventure-one-liner {
			font-size: 1rem;
		}

		.adventure-images-carousel {
			aspect-ratio: 4 / 3;
		}
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const carousels = document.querySelectorAll('.adventure-images-carousel');
		
		carousels.forEach((carousel) => {
			const images = carousel.querySelectorAll('img');
			const indicators = carousel.querySelectorAll('.indicator');
			let currentIndex = 0;
			let hoverInterval: number | null = null;
			const imageCount = images.length;

			if (imageCount <= 1) return;

			const showImage = (index: number) => {
				images.forEach((img, i) => img.classList.toggle('active', i === index));
				indicators.forEach((indicator, i) => indicator.classList.toggle('active', i === index));
			};

			const nextImage = () => {
				currentIndex = (currentIndex + 1) % imageCount;
				showImage(currentIndex);
			};

			carousel.addEventListener('mouseenter', () => {
				hoverInterval = window.setInterval(nextImage, 2000);
			});

			carousel.addEventListener('mouseleave', () => {
				if (hoverInterval) {
					clearInterval(hoverInterval);
					hoverInterval = null;
				}
			});

			indicators.forEach((indicator, index) => {
				indicator.addEventListener('click', (e) => {
					e.stopPropagation();
					currentIndex = index;
					showImage(currentIndex);
				});
			});
		});
	});
</script>

