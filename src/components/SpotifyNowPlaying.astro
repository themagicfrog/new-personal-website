---
interface SpotifyTrack {
	name: string;
	artists: Array<{ name: string }>;
	album: { images: Array<{ url: string }> };
	external_urls: { spotify: string };
}

let currentTrack: SpotifyTrack | null = null;
let isPlaying = false;

try {
	const accessToken = import.meta.env.PUBLIC_SPOTIFY_ACCESS_TOKEN;
	
	if (accessToken) {
		const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
			headers: {
				'Authorization': `Bearer ${accessToken}`
			}
		});

		if (response.ok) {
			const data = await response.json();
			if (data.is_playing && data.item) {
				currentTrack = data.item;
				isPlaying = true;
			}
		}
	}
} catch (err) {
	console.error('Failed to fetch Spotify data:', err);
}
---

{isPlaying && currentTrack && (
	<div class="spotify-widget">
		<div class="spotify-content">
			{currentTrack.album.images[0] && (
				<img 
					src={currentTrack.album.images[0].url} 
					alt={currentTrack.name}
					class="spotify-album-art"
				/>
			)}
			<div class="spotify-info">
				<p class="spotify-label">now playing</p>
				<p class="spotify-track">{currentTrack.name}</p>
				<p class="spotify-artist">{currentTrack.artists.map(a => a.name).join(', ')}</p>
			</div>
		</div>
		<a 
			href={currentTrack.external_urls.spotify} 
			target="_blank" 
			rel="noopener noreferrer"
			class="spotify-link"
		>
			open in spotify â†’
		</a>
	</div>
)}

<style>
	.spotify-widget {
		margin-top: 2rem;
		padding: 1.5rem;
		background-color: #1db954;
		border-radius: 12px;
		color: white;
	}

	.spotify-content {
		display: flex;
		gap: 1rem;
		align-items: center;
		margin-bottom: 1rem;
	}

	.spotify-album-art {
		width: 64px;
		height: 64px;
		border-radius: 8px;
		object-fit: cover;
		flex-shrink: 0;
	}

	.spotify-info {
		flex: 1;
		min-width: 0;
	}

	.spotify-label {
		font-family: 'Dekko', sans-serif;
		font-size: 0.9rem;
		margin: 0 0 0.25rem 0;
		opacity: 0.9;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}

	.spotify-track {
		font-family: 'Dekko', sans-serif;
		font-size: 1.1rem;
		font-weight: 600;
		margin: 0 0 0.25rem 0;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
	}

	.spotify-artist {
		font-family: 'Dekko', sans-serif;
		font-size: 0.95rem;
		margin: 0;
		opacity: 0.85;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
	}

	.spotify-link {
		display: inline-block;
		font-family: 'Dekko', sans-serif;
		font-size: 0.9rem;
		color: white;
		text-decoration: none;
		opacity: 0.9;
		transition: opacity 0.2s;
	}

	.spotify-link:hover {
		opacity: 1;
	}

	@media (max-width: 768px) {
		.spotify-widget {
			padding: 1rem;
		}

		.spotify-album-art {
			width: 56px;
			height: 56px;
		}

		.spotify-track {
			font-size: 1rem;
		}

		.spotify-artist {
			font-size: 0.85rem;
		}
	}
</style>

